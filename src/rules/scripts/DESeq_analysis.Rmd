---
title: "PTPN Knockout"
author: "Kristen Wells"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    highlight: "tango"
    df_print: "paged"
    code_folding: "hide"
    self_contained: true
params:
  genome: "GRCm38"
  DE_alpha: 0.05
  DE_lfc: 1
  counts: "results/PTPN_KO_countTable_cutadapt_trim.txt"
  fastqc: "results/fastqc_summary.tsv"
  star_stats: "results/star_summary_cutadapt_trim.tsv"
  output_dir: "results/R_analysis"
  sample_info: "files/sample_info.csv"
  cytokine_treated_gene_list: "files/WT_vs_KO_cytokine_RNA_Seq_categorized.xlsx"
  untreated_gene_list: "files/WT_vs_KO_Non_treated_RNA_Seq_categorized.xlsx"
  sample_column: "group"
  comparisons:
    value: 
      - ["PTPN2_KO_NoTreatment",        "WT_NoTreatment"]
      - ["WT_Cytokine_Treatment",       "WT_NoTreatment"]
      - ["PTPN2_KO_Cytokine_Treatment", "PTPN2_KO_NoTreatment"]
      - ["PTPN2_KO_Cytokine_Treatment", "WT_Cytokine_Treatment"]
  genes:
    value:
      - "Ins1"
      - "Ins2"
      - "Gbp2"
      - "Gbp5"
      - "Cxcl1"
      - "Pomc"
      - "Chl1" #https://pubmed.ncbi.nlm.nih.gov/32184019/
      - "Npy"
      - "Il33"
      - "Robo1"
      - "Rnasel"
      - "Gbp8"
      - "Serpina3i"
      - "Raet1e"
      - "Ggt1"
      - "Apol7a"
      - "Pcyt1b"
      - "Rps3a1"
      - "Bmp7"
      - "Mapk13"
      - "Sec22c"
      - "Clu"
      - "Pink1"
      - "Lrrtm4"
      - "Mecom"
      - "Cnnm2"
      - "Serpina3n"
      - "Perp"
---
```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/wellskr/Documents/Analysis/Lori_sussel/Young_Kim/Sussel_RNASeq_PTPN/")
```

```{r "Load packages and set options", include = F}
install_packages <- function(install_list, name_list = NULL, 
                             install_cmd = "utils::install.packages", ...) {
  
  # If using devtools::install_github(), the package name will be different 
  # from the repository name in install_list
  if (is.null(name_list)) {
    name_list <- install_list
  }
  
  # Install packages
  for (i in 1:length(install_list)) {
    # require() returns TRUE invisibly if it was able to load package
    if (!require(name_list[i], character.only = T)) {
      
      install_pkg <- strsplit(install_cmd, "::")[[1]][1]
      
      if (!require(install_pkg, character.only = T)) {
        install.packages(install_pkg, dependencies = T, ...)
        require(install_pkg)
      }
      
      install_cmd <- paste0(install_cmd, "(install_list[i], ...)")
      eval(parse(text = install_cmd))
      
      require(name_list[i], character.only = T)
    }
  }
}

# Install CRAN packages
install_packages(c(
  "knitr",    "BiocManager",
  "cowplot",  "tidyverse", 
  "Matrix",   "pheatmap",
  "ggrepel",  "devtools", 
  "gprofiler2", "viridis",
  "RColorBrewer", "ashr",
  "apeglm", "openxlsx"
))

# Install Bioconductor packages
install_packages(c(
  "DESeq2", "pathview",
  "KEGGREST", "org.Hs.eg.db"
), install_cmd = "BiocManager::install")

# Set default chunk options
opts_chunk$set(
  message = F, 
  warning = F,
  comment = ""
)
```


```{r "Load Functions and Theme"}

source("src/rules/scripts/functions.R")

################
# Theme colors #
################

# Colors for heatmap (from the ArchR package)
blueYellow <- c("#352A86", "#343DAE", "#0262E0", "#1389D2", "#2DB7A3",
	"#A5BE6A", "#F8BA43", "#F6DA23", "#F8FA0D")

# Colors for statistics
fastqc_colors <- c("#e31a1c", "#238443", "#ec7014")

star_colors <- c("#737373", "#8c6bb1", "#ec7014",
                 "#e31a1c", "#238443", "#225ea8")
```


## Background
This documents the analysis of the effect of cytokine treatment on PTPN2 KO mice.
This document aims to analyze differences between PTPN2 KO and WT mice in their
response to cytokine treatment.

```{r, "Load in and set up data"}
# Load in the files
###############
# Count table #
###############
# Read in the count table
count_table <- read.table(params$counts, sep = "\t", row.names = 1, header = T)

################
# Sample table #
################

# Read in the sample table
sample_table <- read.table(params$sample_info, sep = ",", header = T,
                           row.names = 1)

# Ensure the count table and sample table are in the same order
count_table <- count_table[ , rownames(sample_table)]

########
# Star #
########

# Read in star stats
star_stats <- read.table(params$star_stats, sep = "\t", row.names = 1,
                         header = T)

# Filter for mapping % and total read counts
star_stats <- star_stats[grepl(
  "%|Uniquely mapped reads|mapped to multiple loci",
  rownames(star_stats)), ]

star_stats <- star_stats[!grepl(
  "^Mismatch|chimeric", rownames(star_stats)), ]

# Calculate median size
star_stats_median <- star_stats[grepl(
  "Uniquely mapped reads", rownames(star_stats)), ]

median_size <- median(as.numeric(
  star_stats_median["Uniquely mapped reads number", ])) / 1000000

median_rate <- median(as.numeric(str_remove(
  star_stats_median["Uniquely mapped reads %", ], "%")))

alignment_qual <- get_alignment_qual(median_rate)

# Pull out all sample names
samples <- colnames(star_stats)

# Make a column of metrics
star_stats$metric <- rownames(star_stats)

# Make into long form for ggplot
star_stats_long <- gather(star_stats, key = "Sample", value = "value",
                          all_of(samples))


# Add column for value type
star_stats_long <- star_stats_long %>%
  mutate(
    value = as.numeric(str_remove(value, "%")),
    val_type = ifelse(grepl("%", metric),
                      "pct", "int")
  )

# Pull out read counts
# Calculate median library size
read_counts <- star_stats_long %>%
  filter(grepl("mapped reads number", metric)) %>%
  mutate(value = round(value / 1000000)) %>%
  mutate(value = str_c(value, " million"))

##########
# FastQC #
##########

# Load in fastqc results
fastqc_summary <- read.table(params$fastqc, sep = "\t")

# Change the colnames
colnames(fastqc_summary) <- c("Result", "Test", "Sample")

# Update sample names
fastqc_summary$Sample <- sub("_S[0-9]*_L[0-9]*_", "", fastqc_summary$Sample)
fastqc_summary$Sample <- sub("_001.fastq.gz", "", fastqc_summary$Sample)

##############
# Set colors #
##############
sample_table[[params$sample_column]] <- 
  factor(sample_table[[params$sample_column]])
sample_colors <- brewer.pal(length(
  levels(sample_table[[params$sample_column]])), "Set1")
names(sample_colors) <- levels(sample_table[[params$sample_column]])

```

# Quality Control {.tabset}

## FastQC Summary
`FastQC` was used to assess the quality of each fastq file. A summary of the results is shown below, the overall library quality was **`r params$library_quality`**.
```{r "Create fastqc summary", fig.width = 8.5, fig.height = 3}
fastqc_plot <- ggplot(data = fastqc_summary,
                      mapping = aes(x = Sample,
                                    y = Test,
                                    fill = Result)) +
  geom_tile(color = "white", size = 0.5) +
  scale_fill_manual(values = fastqc_colors) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.text  = element_text(size = 8, color = "black"),
    axis.title   = element_blank(),
    axis.text    = element_text(size = 8, color = "black"),
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

fastqc_plot
```


## Alignment Summary
Reads were aligned to the `r params$genome` genome using the `STAR` RNA-seq aligner. A summary of the results is shown below, the library size is displayed on each bar. The median library size was `r median_size` million reads and the median alignment rate was `r median_rate`. Overall, the alignment rate was **`r alignment_qual`**. 
```{r "Create alignment summary", fig.width = 8.5, fig.height = 3}

# Plot alignment stats
star_stats_long_pct <- star_stats_long %>%
  filter(val_type == "pct") %>%
  
  # Add median rates to metric label
  mutate(
    metric = str_remove(metric, "% of reads | reads %"),
    metric = str_to_sentence(metric)
  ) %>%
  arrange(value) %>%
  mutate(metric = fct_inorder(metric))
  
# Plot STAR alignment stats
star_plot <- ggplot(data = star_stats_long_pct,
                    mapping = aes(x = Sample,
                                  y = value,
                                  fill = metric)) +
  geom_bar(stat = "identity", color = "white", size = 0.5) +
  
  # Label bars with library size
  geom_text(
    data = read_counts, 
    aes(Sample, 50, label = value),
    show.legend = F,
    inherit.aes = F,
    color = "white", 
    angle = 90
  ) +
  
  scale_fill_manual(
    values = star_colors,
    guide  = guide_legend(reverse = T)
  ) +
  scale_y_continuous(labels = function(x) {str_c(x, "%")}) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.text  = element_text(size = 8, color = "black"),
    axis.title   = element_blank(),
    axis.text    = element_text(size = 8, color = "black"),
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

star_plot

```


## PCA
Principal component analysis was performed to assess similarities between samples. Biological replicates were plotted for each experimental condition. When replicates cluster close together, this suggests that overall gene expression patterns are fairly reproducible.

```{r "Run DESeq2 and create PCA plot", fig.width = 6, fig.height = 4}
# This makes a DESeq2 object where the count data is our count matrix and the colData is our sample data. I am currently making the design based on "group" but we can change this if necessary
sample_table$genotype <- factor(sample_table$genotype,
                                levels = c("PTPN2_KO", "WT"))
sample_table$treatment <- factor(sample_table$treatment,
                                 levels = c("Cytokine_Treatment", "No_Treatment"))
sample_table$group <- factor(sample_table$group,
                                levels = c("PTPN2_KO_Cytokine_Treatment",
                                           "PTPN2_KO_NoTreatment",
                                           "WT_Cytokine_Treatment",
                                           "WT_NoTreatment"))
dds <- DESeqDataSetFromMatrix(countData = count_table,
                              colData = sample_table,
                              #design = formula(paste("~",
                              #                       params$sample_column))
                              design = ~genotype + treatment + 
                                genotype:treatment)

# Here we get rid of all the genes that are not expressed
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
dds <- DESeq(dds)

# Create a model
mod_mat <- model.matrix(design(dds), colData(dds))

PTPN2_non <- colMeans(mod_mat[dds$genotype == "PTPN2_KO" &
                             dds$treatment == "No_Treatment", ])
PTPN2_Cyto <- colMeans(mod_mat[dds$genotype == "PTPN2_KO" &
                              dds$treatment == "Cytokine_Treatment", ])
WT_Non <- colMeans(mod_mat[dds$genotype == "WT" &
                             dds$treatment == "No_Treatment", ])
WT_Cyto <- colMeans(mod_mat[dds$genotype == "WT" &
                              dds$treatment == "Cytokine_Treatment", ])

# This transforms the counts to have constant variance. This helps ensue that highly or lowly expressed genes will not contribute too much for the PCA or clustering analysis
vsd <- vst(dds, blind = F)

plot_pca(vsd, group_by = params$sample_column, color_palette = sample_colors)
```


## Sample Distances
Correlations between samples was determined to further assess similarities between samples. Biological replicates should cluster together. Samples that are more similar to each other have values closer to 0. 

```{r "Determine distance between samples", fig.width= 6, fig.height = 4}
# This determines distance between samples.
get_distances(vsd)
```

# Differential Expression Analysis {.tabset}


```{r "Make directories", include = F}
# Create the output folders if it doesn't already exist
ifelse(!dir.exists(file.path(params$output_dir, "DE_files")),
       dir.create(file.path(params$output_dir, "DE_files")), FALSE)

ifelse(!dir.exists(file.path(params$output_dir, "images")),
       dir.create(file.path(params$output_dir, "images")), FALSE)
ifelse(!dir.exists(file.path(params$output_dir, "images", "heatmaps")),
       dir.create(file.path(params$output_dir, "images",
                            "heatmaps")), FALSE)
ifelse(!dir.exists(file.path(params$output_dir, "images", "GSE")),
       dir.create(file.path(params$output_dir, "images", "GSE")), FALSE)
ifelse(!dir.exists(file.path(params$output_dir, "GSE_files")),
       dir.create(file.path(params$output_dir, "GSE_files")), FALSE)
```

```{r "Run differential experession chunks", echo = F}
contrasts <- list(
  list("PTPN2_WT_noTrt", (PTPN2_non - WT_Non),
       "PTPN2_KO_NoTreatment:WT_NoTreatment"),
  list("WT_PTPN2_noTrt", (WT_Non - PTPN2_non),
       "WT_NoTreatment:PTPN2_KO_NoTreatment"),
  list("WT_trt", (WT_Non - WT_Cyto),
       "WT_Cytokine_Treatment:WT_NoTreatment"),
  list("PTPN2_trt", (PTPN2_non - PTPN2_Cyto),
       "PTPN2_KO_Cytokine_Treatment:PTPN2_KO_NoTreatment"),
  list("PTPN2_WT_Trt", (PTPN2_Cyto - WT_Cyto),
       "PTPN2_KO_Cytokine_Treatment:WT_Cytokine_Treatment"),
  list("PTPN2_specific_trt", ((PTPN2_non - PTPN2_Cyto) - (WT_Non - WT_Cyto)),
       "PTPN2_KO_Cytokine_Treatment:PTPN2_KO_NoTreatment")
  )

#DE_chunks <- params$comparisons %>%
#  map(~knit_expand(file ="src/rules/scripts/DESeq_template.Rmd",
#                   interaction = FALSE))

de_template <- "src/rules/scripts/DESeq_template.Rmd"
#de_template <- "src/rules/scripts/test_contrast.Rmd"

DE_chunks <- contrasts %>%
  map(~knit_expand(file = de_template,
                   interaction = TRUE))
```

`r knit_child(text = DE_chunks)`


# Gene plots {.tabset}
Gene plots show the normalized expression of key genes across all samples. We can add in any genes that you would like to see in this format.
```{r "Make gene directories", include = F}
ifelse(!dir.exists(file.path(params$output_dir, "images", "gene_plots")),
       dir.create(file.path(params$output_dir, "images", "gene_plots")), FALSE)


```

```{r "Run gene experession chunks", echo = F}
gene_chunks <- params$genes %>%
  map(~knit_expand("src/rules/scripts/gene_plots_template.Rmd"))
```

`r knit_child(text = gene_chunks)`

# Heatmaps

## Cytokine treated samples {.tabset}
```{r "Read in gene lists cytokine"}
gene_lists <- openxlsx::getSheetNames(params$cytokine_treated_gene_list)
gene_file <- params$cytokine_treated_gene_list

control <- "WT_Cytokine_Treatment"
treatment <- "PTPN2_KO_Cytokine_Treatment"

heatmap_chunks <- gene_lists %>%
  map(~knit_expand("src/rules/scripts/heatmap_template.Rmd"))

```

`r knit_child(text = heatmap_chunks)`

## Non cytokine treated samples {.tabset}
```{r "Read in gene lists non treated", fig.height=8, fig.width=10}
gene_lists <- openxlsx::getSheetNames(params$untreated_gene_list)
gene_file <- params$untreated_gene_list

control <- "WT_NoTreatment"
treatment <- "PTPN2_KO_NoTreatment"

heatmap_chunks <- gene_lists %>%
  map(~knit_expand("src/rules/scripts/heatmap_template.Rmd"))

```

`r knit_child(text = heatmap_chunks)`

# Session Info

```{r}
sessionInfo()
```

```{r}
ifelse(!dir.exists(file.path(params$output_dir, "objs")),
       dir.create(file.path(params$output_dir, "objs")), FALSE)
saveRDS(dds, paste0(params$output_dir, "/objs/dds_obj.rda"))

saveRDS(vsd, paste0(params$output_dir, "/objs/vsd_obj.rda"))
```